#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>
echo "STARTING COMPILE"

# fail fast
set -e

BPLOG_PREFIX="buildpack.java"

BP_DIR=$(cd $(dirname $0)/..; pwd) # absolute path
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

echo "SOURCING $BP_DIR/lib/common.sh"

source $BP_DIR/lib/common.sh
echo "SOURCING $BP_DIR/lib/maven.sh"
source $BP_DIR/lib/maven.sh
echo "SOURCING $BUILDPACK_STDLIB_URL"
source <(curl -s --retry 3 -L $BUILDPACK_STDLIB_URL)

echo "EXPORTING VARS"
export_env $ENV_DIR "." "JAVA_OPTS|JAVA_TOOL_OPTIONS"

echo "INSTALLING JDK"
install_jdk "${BUILD_DIR}" "${CACHE_DIR}"

echo "FINDING SOURCES"
[ -n "$(find ${BUILD_DIR} -type f -name "*.kt")" ] && mcount "kotlin.source"
[ -n "$(find ${BUILD_DIR} -type f -name "*.groovy")" ] && mcount "groovy.source"
echo "BEGIN COMPILE"
run_mvn "compile" $BUILD_DIR $CACHE_DIR
echo "REMOVING MAVEN"
remove_mvn $BUILD_DIR $CACHE_DIR
echo "FINISHED COMPILE"
